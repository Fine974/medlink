<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ç–¾ç—…é¢„æµ‹æ¨¡å‹è°ƒç”¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- å¼•å…¥å…¬å…±CSS -->
    <link rel="stylesheet" href="/css/common.css">
    <style>
        #predictionResult {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        #predictionResult ul {
            list-style-type: disc;
            padding-left: 20px;
        }

        #predictionResult li {
            margin-bottom: 5px;
            font-weight: 500;
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">

<!-- å¯¼èˆªæ  -->
<div data-include="header.html"></div>

<div class="container py-5">
    <h2 class="mb-4 text-center text-primary">
        <i class="bi bi-robot"></i> ç–¾ç—…é¢„æµ‹æ¨¡å‹
    </h2>

    <div class="row justify-content-center mb-3">
        <div class="col-md-4">
            <input type="text" id="diseaseInput" class="form-control" placeholder="è¯·è¾“å…¥ç–¾ç—…åç§°ï¼ˆå¦‚ breast cancerï¼‰">
        </div>
        <div class="col-md-2">
            <button id="predictBtn" class="btn btn-success w-100" onclick="startPrediction()">å¼€å§‹é¢„æµ‹</button>
        </div>
    </div>

    <div id="loadingMsg" class="mt-3 text-info" style="display: none;">ğŸ”„ æ­£åœ¨é¢„æµ‹ä¸­ï¼Œè¯·ç¨å€™...</div>

    <div class="mt-4">
        <h5>é¢„æµ‹æ—¥å¿—è¾“å‡ºï¼š</h5>
        <pre id="logOutput" class="p-3 bg-dark text-light" style="height: 400px; overflow-y: auto; border-radius: 5px;"></pre>
    </div>

    <div id="predictionResult">
        <h3>è¯ç‰©æ¨èç»“æœï¼š</h3>
        <ul id="drugList"></ul>
    </div>

</div>

<!-- é¡µè„š -->
<footer class="footer mt-auto text-center">
    <div class="container">
        <p>&copy; 2025 MedLink è¯ç‰©é¢„æµ‹å¹³å°</p>
        <a href="#">å…³äºæˆ‘ä»¬</a> | <a href="#">è”ç³»æˆ‘ä»¬</a>
    </div>
</footer>

<!-- å¿…è¦JSåº“ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="js/include.js"></script>

<script>
    function startPrediction() {
        const disease = document.getElementById('diseaseInput').value.trim();
        const btn = document.getElementById('predictBtn');
        const logOutput = document.getElementById('logOutput');
        const loadingMsg = document.getElementById('loadingMsg');

        if (!disease) {
            alert('è¯·è¾“å…¥ç–¾ç—…åç§°');
            return;
        }

        btn.disabled = true;
        loadingMsg.style.display = 'block';
        logOutput.textContent = '';

        const eventSource = new EventSource(`/api/predict/stream?disease=${encodeURIComponent(disease)}`);

        // ç›‘å¬æ­£å¸¸æ•°æ®æµ
        eventSource.onmessage = function(event) {
            if (event && event.data) {
                logOutput.textContent += event.data + "\n";
                logOutput.scrollTop = logOutput.scrollHeight;
            }
        };

        // è·å–æ¨èè¯ç‰©åˆ—è¡¨å®¹å™¨
        const drugList = document.getElementById('drugList');

        // æ¸…ç©ºæ—§ç»“æœ
        drugList.innerHTML = "";

        // ç›‘å¬è¯ç‰©æ¨èæ•°æ®
        eventSource.addEventListener("result", function(event) {
            if (event && event.data) {
                const li = document.createElement("li");
                li.textContent = event.data;
                drugList.appendChild(li);
            }
        });

        // ç›‘å¬ end äº‹ä»¶
        eventSource.addEventListener("end", function(event) {
            logOutput.textContent += "[é¢„æµ‹å®Œæˆ]\n";
            logOutput.scrollTop = logOutput.scrollHeight;
            loadingMsg.style.display = 'none';
            btn.disabled = false;
            eventSource.close();
        });

        // ç›‘å¬é”™è¯¯äº‹ä»¶
        eventSource.onerror = function(err) {
            logOutput.textContent += "[è¿æ¥é”™è¯¯æˆ–ä¸­æ–­]\n";
            logOutput.scrollTop = logOutput.scrollHeight;
            loadingMsg.style.display = 'none';
            btn.disabled = false;
            eventSource.close();
        };
    }

</script>

</body>
</html>
