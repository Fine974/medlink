<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>è¯ç‰©è¯¦æƒ… - MedLink</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- å¼•å…¥å…¬å…±CSS -->
    <link rel="stylesheet" href="/css/common.css">
    <style>
        .drug-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            object-fit: cover;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .card-title {
            color: #0066cc;
            font-weight: 600;
        }

        .drug-label {
            font-weight: bold;
            color: #444;
        }

        .drug-section p {
            margin-bottom: 8px;
        }

        .drug-image {
            max-width: 150px;
            max-height: 150px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            object-fit: contain;
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">

<!-- é¡¶éƒ¨å¯¼èˆª -->
<div data-include="header.html"></div>

<!-- è¯ç‰©è¯¦æƒ…ä¸»ä½“ -->
<div class="container mt-4">
    <div class="card p-4 d-flex flex-row align-items-center">
        <div class="flex-grow-1">
            <h3 id="drug-name" class="card-title"><i class="bi bi-capsule"></i>è¯ç‰©åç§°</h3>
            <p><i class="bi bi-tag"></i><span class="drug-label">æ•°æ®åº“ IDï¼š</span><span id="drug-db-id">DB12345</span></p>
            <p><i class="bi bi-globe"></i><span class="drug-label">è‹±æ–‡åï¼š</span><span id="drug-english-name">Drug Name</span></p>
            <p><i class="bi bi-chat-dots"></i><span class="drug-label">ä¸­æ–‡åï¼š</span><span id="drug-chinese-name">è¯ç‰©åç§°</span></p>
        </div>
        <img id="drug-image" src="" alt="è¯ç‰©å›¾ç‰‡" class="drug-image me-4 d-none d-md-block"
             onerror="this.style.display='none'" onclick="openModal(this.src)">
    </div>

    <div class="card p-4 d-flex flex-column">
        <h4 class="card-title mb-3">è¯ç‰©-ç–¾ç—…å…³ç³»å›¾è°±</h4>
        <div id="relation-graph" style="width: 100%; height: 500px;"></div>
    </div>

    <!-- è¯¦ç»†ä¿¡æ¯å¡ç‰‡ -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card p-3 drug-section">
                <h5 class="card-title">é€šç”¨åç§°</h5>
                <p id="drug-generic-name">æš‚æ— æ•°æ®</p>
            </div>
            <div class="card p-3 drug-section">
                <h5 class="card-title">æ‘˜è¦</h5>
                <p id="drug-summary">æš‚æ— æ•°æ®</p>
            </div>
            <div class="card p-3 drug-section">
                <h5 class="card-title">èƒŒæ™¯ä¿¡æ¯</h5>
                <p id="drug-background">æš‚æ— æ•°æ®</p>
            </div>
            <div class="card p-3 drug-section">
                <h5 class="card-title">é€‚åº”ç—‡</h5>
                <p id="drug-indication">æš‚æ— æ•°æ®</p>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3 drug-section">
                <h5 class="card-title">ç±»å‹</h5>
                <p id="drug-type">æš‚æ— æ•°æ®</p>
            </div>
            <div class="card p-3 drug-section">
                <h5 class="card-title">æè¿°</h5>
                <p id="drug-description">æš‚æ— æè¿°</p>
            </div>
            <div class="card p-3 drug-section">
                <h5 class="card-title">ä½œç”¨æœºåˆ¶</h5>
                <p id="drug-mechanism">æš‚æ— ä¿¡æ¯</p>
            </div>
            <div class="card p-3 drug-section">
                <h5 class="card-title">è¯æ•ˆåŠ¨åŠ›å­¦</h5>
                <p id="drug-pharmacodynamics">æš‚æ— æ•°æ®</p>
            </div>
            <div class="card p-3 drug-section">
                <h5 class="card-title">è¯ç‰©åˆ†ç»„</h5>
                <p id="drug-group">æš‚æ— åˆ†ç»„</p>
            </div>
        </div>
    </div>
</div>

<!-- é¡µè„š -->
<footer class="footer mt-auto text-center">
    <div class="container">
        <p>&copy; 2025 MedLink è¯ç‰©é¢„æµ‹å¹³å°</p>
        <a href="#">å…³äºæˆ‘ä»¬</a> | <a href="#">è”ç³»æˆ‘ä»¬</a>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="js/include.js"></script>

<script>
    // å…¨å±€è·å– drugId
    const drugId = new URLSearchParams(window.location.search).get('id');

    if (drugId) {
        // ------------------------- è·å–è¯ç‰©è¯¦æƒ… -------------------------
        fetch(`/api/drugs/${drugId}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('drug-name').textContent = data.chineseName || "æœªå‘½åè¯ç‰©";
                document.getElementById('drug-db-id').textContent = data.dbId || "æ— ";
                document.getElementById('drug-english-name').textContent = data.englishName || "æ— ";
                document.getElementById('drug-chinese-name').textContent = data.chineseName || "æ— ";
                document.getElementById('drug-generic-name').textContent = data.genericName || "æš‚æ— æ•°æ®";
                document.getElementById('drug-summary').textContent = data.summary || "æš‚æ— æ•°æ®";
                document.getElementById('drug-background').textContent = data.background || "æš‚æ— æ•°æ®";
                document.getElementById('drug-type').textContent = data.type || "æš‚æ— æ•°æ®";
                document.getElementById('drug-description').textContent = data.description || "æš‚æ— æè¿°";
                document.getElementById('drug-indication').textContent = data.indication || "æš‚æ— é€‚åº”ç—‡";
                document.getElementById('drug-mechanism').textContent = data.mechanismOfAction || "æš‚æ— ä¿¡æ¯";
                document.getElementById('drug-pharmacodynamics').textContent = data.pharmacodynamics || "æš‚æ— æ•°æ®";
                document.getElementById('drug-group').textContent = data.groupName || "æš‚æ— åˆ†ç»„";
                document.getElementById('drug-image').src = `https://go.drugbank.com/structures/${data.dbId}/thumb.svg`;
            })
            .catch(error => {
                console.error('âŒ è·å–è¯ç‰©è¯¦æƒ…å¤±è´¥:', error);
            });

        // ------------------------- è·å–å›¾è°±æ•°æ® -------------------------
        fetch(`/api/drugs/drug-graph/${drugId}`)
            .then(res => res.json())
            .then(graphData => {
                const chartDom = document.getElementById('relation-graph');
                const myChart = echarts.init(chartDom);

                const option = {
                    animation: true,
                    animationDuration: 1200,
                    animationEasing: 'easeOutElastic',

                    tooltip: {
                        formatter: (params) => {
                            if (params.data.category === "è¯ç‰©") return `ğŸ’Š è¯ç‰©ï¼š${params.data.name}`;
                            if (params.data.category === "ç–¾ç—…") return `ğŸ§¬ ç–¾ç—…ï¼š${params.data.name}`;
                            return params.data.relation || '';
                        }
                    },

                    legend: [{ data: ['è¯ç‰©', 'ç–¾ç—…'] }],

                    series: [{
                        type: 'graph',
                        layout: 'force',
                        roam: true,

                        label: {
                            show: true,
                            position: 'right',
                            fontSize: 12
                        },

                        force: {
                            repulsion: 500,    // èŠ‚ç‚¹é—´è·æ›´å¤§
                            edgeLength: [100, 200],
                            gravity: 0.2
                        },

                        edgeSymbol: ['none', 'arrow'],
                        edgeSymbolSize: [4, 8],
                        edgeLabel: {
                            show: true,
                            fontSize: 10,
                            formatter: function (params) {
                                return params.data.label || '';
                            }
                        },

                        categories: [
                            { name: 'è¯ç‰©', itemStyle: { color: '#1f77b4' } },
                            { name: 'ç–¾ç—…', itemStyle: { color: '#ff7f0e' } }
                        ],

                        data: graphData.nodes.map(node => ({
                            ...node,
                            symbolSize: node.category === 'è¯ç‰©' ? 70 : 50,
                            category: node.category
                        })),

                        links: graphData.links.map(link => ({
                            source: link.source,
                            target: link.target,
                            label: { show: true, formatter: link.relation },
                            lineStyle: { curveness: 0.25 }
                        })),

                        lineStyle: {
                            color: '#aaa',
                            width: 2
                        }
                    }]
                };

                myChart.setOption(option);
            })
            .catch(error => {
                console.warn('âš ï¸ è·å–å›¾è°±æ•°æ®å¤±è´¥:', error);
            });
    } else {
        console.warn('âš ï¸ æœªæä¾› drugId å‚æ•°');
    }

    // ------------------------- å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ -------------------------
    function openModal(imageSrc) {
        const modalImage = document.getElementById('modalImage');
        modalImage.src = imageSrc;
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
    }
</script>


<!-- æ¨¡æ€æ¡†ç»“æ„ -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content" style="height: 90vh;"> <!-- é™åˆ¶æ•´ä¸ªæ¨¡æ€æ¡†é«˜åº¦ -->
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">è¯ç‰©å›¾ç‰‡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0" style="height: calc(90vh - 56px); overflow: hidden;">
                <img id="modalImage" src="" alt="æ”¾å¤§åçš„å›¾ç‰‡" style="max-height: 100%; max-width: 100%; object-fit: contain;" class="w-100 h-100">
            </div>
        </div>
    </div>
</div>

